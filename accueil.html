<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-width=1.0" />
<title>Domo-Connect ‚Äî Tableau de Bord</title>
<style>
/* Votre style CSS est conserv√© */
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',Tahoma,sans-serif;background:linear-gradient(145deg,#0c0c12,#1b1b26);color:#e0e0e0;min-height:100vh;padding:20px;}
.hidden{display:none;}
header{display:flex;justify-content:space-between;align-items:center;padding:25px 40px;background:rgba(139,0,255,0.1);border-radius:15px;margin-bottom:30px;backdrop-filter:blur(10px);border:1px solid rgba(139,0,255,0.2);}
.deconnexion{background:linear-gradient(135deg,#8b00ff,#6200ea);color:white;padding:12px 28px;border-radius:8px;cursor:pointer;}
.accueil-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:25px;max-width:1400px;margin:0 auto;}
.module{background:rgba(30,30,46,0.8);border-radius:15px;padding:25px;border:1px solid rgba(139,0,255,0.2);box-shadow:0 8px 32px rgba(0,0,0,0.3);}
.module h2{color:#bb86fc;margin-bottom:20px;font-size:1.5rem;border-bottom:2px solid rgba(139,0,255,0.3);padding-bottom:10px;}
.status-btn{border:2px solid;padding:8px 20px;border-radius:20px;font-weight:600;font-size:0.9rem;min-width:80px;background:transparent;cursor:pointer;transition:all 0.2s ease;}
.status-btn.off{color:#ff6b6b;border-color:#ff6b6b;background:rgba(255,107,107,0.1);}
.status-btn.on{color:#bb86fc;border-color:#bb86fc;background:rgba(187,134,252,0.1);} 
.module table{width:100%;border-collapse:collapse;}
.module td{padding:12px;font-size:0.95rem;}
.module td:first-child{color:#c0c0c0;}
.module td:last-child{text-align:right;}
.reset-btn{display:block;margin:40px auto;padding:12px 30px;background:linear-gradient(135deg,#ff7e5f,#feb47b);border:none;border-radius:10px;font-size:1rem;color:#1b1b26;font-weight:600;cursor:pointer;}
.deconnexion-container{display:flex;justify-content:center;align-items:center;min-height:100vh;}
.deconnexion-card{background:rgba(30,30,46,0.9);border-radius:20px;padding:60px;text-align:center;border:2px solid rgba(139,0,255,0.3);box-shadow:0 20px 60px rgba(139,0,255,0.3);}
.deconnexion-card h1{font-size:3rem;color:#bb86fc;margin-bottom:10px;}
.btn-retour{display:inline-block;background:linear-gradient(135deg,#8b00ff,#6200ea);color:#fff;text-decoration:none;padding:15px 35px;border-radius:10px;font-size:1.1rem;}
</style>
</head>
<body onload="fetchInitialStates()"> <div id="page-accueil" class="accueil-container">
  <header class="main-header">
    <h1>Bonjour <span id="user-name">Admin</span></h1>
    <button class="deconnexion" onclick="showLogout()">Se D√©connecter</button>
  </header>

  <div class="module">
    <h2>üí° Luminaires RDC</h2>
    <table>
      <tr><td>Cuisine - Luminaire entr√©e</td><td><button id="Cuisine - Luminaire entr√©e" class="status-btn off" onclick="toggleDevice(this, 'light', 'Cuisine - Luminaire entr√©e')">OFF</button></td></tr>
      <tr><td>Cuisine - Luminaire √Ælot central</td><td><button id="Cuisine - Luminaire √Ælot central" class="status-btn off" onclick="toggleDevice(this, 'light', 'Cuisine - Luminaire √Ælot central')">OFF</button></td></tr>
      <tr><td>Salon - Luminaire salon nord</td><td><button id="Salon - Luminaire salon nord" class="status-btn off" onclick="toggleDevice(this, 'light', 'Salon - Luminaire salon nord')">OFF</button></td></tr>
      <tr><td>Salon - Applique chemin√©e sud</td><td><button id="Salon - Applique chemin√©e sud" class="status-btn off" onclick="toggleDevice(this, 'light', 'Salon - Applique chemin√©e sud')">OFF</button></td></tr>
      <tr><td>Salle √† manger - Luminaire central</td><td><button id="Salle √† manger - Luminaire central" class="status-btn off" onclick="toggleDevice(this, 'light', 'Salle √† manger - Luminaire central')">OFF</button></td></tr>
      <tr><td>WC RDC - Luminaire central</td><td><button id="WC - Luminaire central" class="status-btn off" onclick="toggleDevice(this, 'light', 'WC - Luminaire central')">OFF</button></td></tr>
      <tr><td>Hall nord - Luminaire central</td><td><button id="Hall nord - Luminaire central" class="status-btn off" onclick="toggleDevice(this, 'light', 'Hall nord - Luminaire central')">OFF</button></td></tr>
    </table>
  </div>

  <div class="module">
    <h2>üö™ Volets & Portes RDC</h2>
    <table>
      <tr><td>Hall nord - Volet roulant grande baie vitr√©e</td><td><button id="Hall nord - Volet roulant grande baie vitr√©e" class="status-btn off" onclick="toggleDevice(this, 'store', 'Hall nord - Volet roulant grande baie vitr√©e')">OFF</button></td></tr>
      <tr><td>Salon - Volet roulant fen√™tre sud</td><td><button id="Salon - Volet roulant fen√™tre sud" class="status-btn off" onclick="toggleDevice(this, 'store', 'Salon - Volet roulant fen√™tre sud')">OFF</button></td></tr>
      <tr><td>Cuisine - Volet roulant porte fen√™tre terrasse</td><td><button id="Cuisine - Volet roulant porte fen√™tre terrasse" class="status-btn off" onclick="toggleDevice(this, 'store', 'Cuisine - Volet roulant porte fen√™tre terrasse')">OFF</button></td></tr>
      <tr><td>Garage Nord - Porte basculante nord</td><td><button id="Garages nord - Porte basculante nord" class="status-btn off" onclick="toggleDevice(this, 'store', 'Garages nord - Porte basculante nord')">OFF</button></td></tr>
      <tr><td>Garage Ouest - Porte basculante ouest</td><td><button id="Garages ouest - Porte basculante ouest" class="status-btn off" onclick="toggleDevice(this, 'store', 'Garages ouest - Porte basculante ouest')">OFF</button></td></tr>
    </table>
  </div>

  <div class="module">
    <h2>üõèÔ∏è Luminaires √âtages</h2>
    <table>
      <tr><td>Suite parentale - Luminaire central</td><td><button id="Suite parentale - Luminaire central" class="status-btn off" onclick="toggleDevice(this, 'light', 'Suite parentale - Luminaire central')">OFF</button></td></tr>
      <tr><td>Chambre invit√©s - Luminaire central</td><td><button id="Chambre invit√©s - Luminaire central" class="status-btn off" onclick="toggleDevice(this, 'light', 'Chambre invit√©s - Luminaire central')">OFF</button></td></tr>
      <tr><td>Bureau - Luminaire central</td><td><button id="Bureau - Luminaire central" class="status-btn off" onclick="toggleDevice(this, 'light', 'Bureau - Luminaire central')">OFF</button></td></tr>
      <tr><td>Chambre N-E - Luminaire central</td><td><button id="Chambre nord est - Luminaire central" class="status-btn off" onclick="toggleDevice(this, 'light', 'Chambre nord est - Luminaire central')">OFF</button></td></tr>
      <tr><td>SDB N-E - Luminaire central</td><td><button id="Chambre nord est - Salle de bain - Luminaire central" class="status-btn off" onclick="toggleDevice(this, 'light', 'Chambre nord est - Salle de bain - Luminaire central')">OFF</button></td></tr>
      <tr><td>Salle de jeux - Luminaire central nord</td><td><button id="Salle de jeux - Luminaire central nord" class="status-btn off" onclick="toggleDevice(this, 'light', 'Salle de jeux - Luminaire central nord')">OFF</button></td></tr>
    </table>
  </div>

  <div class="module">
    <h2>‚öôÔ∏è Syst√®mes G√©n√©riques & Tests</h2>
    <table>
      <tr><td>Contr√¥le Lumi√®re G√©n√©rique</td><td><button id="lumiere" class="status-btn off" onclick="toggleDevice(this, 'light', 'lumiere')">OFF</button></td></tr>
      <tr><td>Contr√¥le Volets G√©n√©rique</td><td><button id="volets" class="status-btn off" onclick="toggleDevice(this, 'store', 'volets')">OFF</button></td></tr>
      <tr><td>Contr√¥le Climatisation G√©n√©rique</td><td><button id="clim" class="status-btn off" onclick="toggleDevice(this, 'climate', 'clim')">OFF</button></td></tr>
    </table>
  </div>

  <button class="reset-btn" onclick="resetDB()">üîÑ R√©initialiser la base</button>
</div>

<div id="page-logout" class="hidden">
  <div class="deconnexion-container">
    <div class="deconnexion-card">
      <h1>√Ä bient√¥t üëã</h1>
      <p>Vous avez √©t√© d√©connect√© avec succ√®s</p>
      <a href="#" class="btn-retour" onclick="showAccueil()">Retour au tableau de bord</a>
    </div>
  </div>
</div>

<script>
const dashPage = document.getElementById('page-accueil');
const logoutPage = document.getElementById('page-logout');

// =========================================================
// GESTION DES PAGES (Logout/Accueil)
// =========================================================
function showLogout(){
  dashPage.classList.add('hidden');
  logoutPage.classList.remove('hidden');
}

function showAccueil(){
  logoutPage.classList.add('hidden');
  dashPage.classList.remove('hidden');
}

// =========================================================
// SYNCHRONISATION DES √âTATS (NOUVEAU)
// =========================================================

// Fonction pour mettre √† jour un bouton sp√©cifique
function updateButtonState(name, state) {
    const btn = document.getElementById(name);
    if (!btn) return;

    btn.classList.remove('on', 'off');
    
    if (state.toUpperCase() === 'ON') {
        btn.classList.add('on');
        btn.textContent = 'ON';
    } else {
        btn.classList.add('off');
        btn.textContent = 'OFF';
    }
}


// R√©cup√®re l'√©tat initial des appareils g√©n√©riques pour l'exemple
function fetchInitialStates() {
    // Liste des appareils dont nous voulons r√©cup√©rer l'√©tat au chargement
    // NOTE : Le serveur C ne renvoie pas nativement TOUS les 96 √©tats
    // Il faut donc les chercher appareil par appareil ou modifier le serveur C.
    // Pour l'instant, on se base sur l'√©tat g√©n√©ral des appareils g√©n√©riques de test.
    
    // Pour la synchronisation de tous les appareils, chaque bouton doit avoir un ID 
    // correspondant exactement √† son nom (ce qui est fait ci-dessus).

    // Pour l'instant, on va chercher l'√©tat de nos 3 appareils g√©n√©riques (pour le test)
    fetch('/state')
        .then(r => {
            if (!r.ok) throw new Error('Erreur r√©seau');
            return r.text();
        })
        .then(data => {
            // Exemple de donn√©es re√ßues: lumiere=ON;volets=OFF;clim=OFF
            const pairs = data.split(';');
            pairs.forEach(pair => {
                const [name, state] = pair.split('=');
                if (name && state) {
                    updateButtonState(name, state); // Met √† jour 'lumiere', 'volets', 'clim'
                }
            });
        })
        .catch(e => {
            console.error('Erreur chargement √©tats initiaux:', e);
            // Si la connexion √©choue, on suppose que le serveur est down
            alert("Erreur de connexion au serveur C. Veuillez v√©rifier si domoserver.exe est lanc√©.");
        });
        
    // Pour synchroniser l'ensemble des 96 appareils, 
    // il faudrait impl√©menter une route '/all-states' dans domoserver.c
    // qui renverrait un JSON ou un format lisible de tous les √©tats.
}


// =========================================================
// CONTR√îLE DES APPAREILS
// =========================================================

// üîÅ R√©initialisation de la base
function resetDB(){
  fetch('/reset-db')
    .then(r => r.text())
    .then(txt => {
        alert(txt + "\n\n(Veuillez recharger la page pour synchroniser)");
        fetchInitialStates(); // Tente de re-synchroniser apr√®s le reset
    })
    .catch(e => alert('Erreur lors de la r√©initialisation : ' + e));
}

// üí° Fonction pour g√©rer le changement d'√©tat d'un appareil
function toggleDevice(btn, type, name){
  let newState;
  // D√©terminer le nouvel √©tat
  if(btn.classList.contains('off')){
    newState='ON';
  } else {
    newState='OFF';
  }
  
  // Mettre √† jour l'affichage imm√©diatement 
  updateButtonState(name, newState); // Utilisation de la fonction centralis√©e
  
  console.log(`Sending: /update?type=${type}&nom=${name}&etat=${newState}`);

  // Envoi de la requ√™te au serveur C (domoserver.exe)
  fetch(`/update?type=${type}&nom=${encodeURIComponent(name)}&etat=${newState}`)
    .then(r => r.text())
    .then(txt => {
        console.log('Server response:', txt);
        if (txt.includes("Missing params") || txt.includes("400 Bad Request")) {
             console.error('Erreur: Le serveur n\'a pas trait√© la commande.');
             alert('Erreur: Le serveur n\'a pas trait√© la commande (mauvais nom d\'appareil?).');
             // Revenir √† l'√©tat pr√©c√©dent en cas de Bad Request
             updateButtonState(name, (newState === 'ON' ? 'OFF' : 'ON'));
        }
    })
    .catch(e => {
        console.error('Erreur de communication avec le serveur:', e);
        alert(`Erreur de connexion (domoserver.exe non lanc√© ou port occup√©).`);
        // Revenir √† l'√©tat pr√©c√©dent en cas d'√©chec de la requ√™te
        updateButtonState(name, (newState === 'ON' ? 'OFF' : 'ON'));
    });
}
</script>

</body>
</html>